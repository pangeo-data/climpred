# uv Migration Specification

This document outlines the decisions and specifications for migrating climpred's package management from pip to uv.

## Overview

- **Migration Date**: January 2026
- **Uv Version Used**: 0.9.26 (in CI)
- **Package Manager**: uv for dependency management and installation

## Key Decisions

### 1. Lock File Management

**Decision**: Do NOT commit `uv.lock` to the repository.

**Rationale**:
- uv 0.9.24 (local) generates a different lock file format than uv 0.9.26 (CI)
- Local format: `# This file was autogenerated by uv...` with `package = "version"` format
- CI format: `version = 1, revision = 3` with TOML-structured format
- The format mismatch causes CI failures due to "Failed to parse `uv.lock`" errors

**Implementation**:
```bash
# Add to .gitignore
uv.lock

# Remove from git tracking
git rm --cached uv.lock
git add .gitignore
git commit -m "Remove uv.lock from git tracking"
```

### 2. GitHub Actions Workflow

**Decision**: Use `uv run` for all commands that need package dependencies.

**Implementation**:
```yaml
- name: Install dependencies
  run: |
    uv run pip install -e .[complete]
    uv run python -c "import climpred"

- name: Run tests
  run: |
    uv run pytest -n 4 --durations=20
```

**Rationale**:
- `uv run` creates a temporary virtual environment and runs the command within it
- Ensures all dependencies from `pyproject.toml` are available
- Works cross-platform (Linux, macOS, Windows)
- Avoids issues with `source .venv/bin/activate` on Windows PowerShell

### 3. Optional Dependencies

**Decision**: Use proper extras for different use cases.

**Implementation**:
```toml
[project.optional-dependencies]
test = [
    "netcdf4",
    "h5netcdf",
    "h5py",  # Required by h5netcdf
    "pre-commit",
    "pytest <8.0.0",
    "pytest-cov",
    "pytest-lazy-fixture",
    "pytest-xdist",
]
docs = [
    "climpred[complete]",
    "myst_nb",
    "nbstripout",  # Must be installed separately
    "sphinx",
    "sphinx-book-theme >=0.3.3",
    "sphinx-copybutton",
    "sphinxcontrib-bibtex",
    "sphinxcontrib-napoleon",
]
complete = ["climpred[accel,bias-correction,viz,io,test,relative_entropy,vwmp]"]
```

**Notes**:
- `h5py` must be explicitly listed as it's not automatically pulled by `h5netcdf` in some environments
- `nbstripout` needs separate installation for notebooks workflow

### 4. Test Execution

**Decision**: Use `uv run pytest` instead of `uv run python -m pytest`.

**Implementation**:
```yaml
- name: Run tests
  run: |
    uv run pytest -n 4 --durations=20
```

**Rationale**:
- `uv run python -m pytest` creates an ephemeral environment without the project's editable install
- `uv run pytest` uses the environment where the package was installed

### 5. Combining pip install Commands

**Decision**: Combine all `uv run pip install` commands into a single step.

**Implementation**:
```yaml
- name: Install climpred[complete]
  run: |
    uv run pip install -e .[complete] 'xarray<2024.2.0'
```

**Rationale**:
- Each `uv run` creates a separate temporary environment
- Installing multiple packages separately causes subsequent commands to fail (missing pytest, etc.)

## Workflow Changes

### climpred_installs.yml

```yaml
jobs:
  install-climpred:  # Simplified, no uv.lock needed
    steps:
    - uses: actions/checkout@v4
    - name: Setup Python
      uses: actions/setup-python@v5
    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true
    - name: Install dependencies
      run: |
        uv run pip install -e .[complete]
        uv run python -c "import climpred"
```

### climpred_testing.yml

```yaml
minimum-test:
  steps:
    - name: Install climpred
      run: |
        uv run pip install -e .[test]
        uv run pip uninstall netcdf4 -y
    - name: Run tests
      run: |
        uv run pytest -n 4 --durations=20

maximum-test:
  steps:
    - name: Install climpred[complete]
      run: |
        uv run pip install -e .[complete]
    - name: Run tests
      run: |
        uv run pytest -n 4 --durations=20 --cov=climpred --cov-report=xml

doctest:
  steps:
    - name: Install climpred[complete]
      run: |
        uv run pip install -e .[complete] 'xarray<2024.2.0'
    - name: Run doctests
      run: |
        uv run pytest --doctest-modules src/climpred --ignore src/climpred/tests

notebooks:
  steps:
    - name: Install climpred
      run: |
        uv run pip install -e .[docs]
    - name: Install nbstripout
      run: |
        uv run pip install nbstripout
    - name: Test notebooks in docs
      run: |
        pushd docs
        nbstripout source/*.ipynb source/examples/decadal/*.ipynb source/examples/monseas/*.ipynb examples/subseasonal/*ly-subx-example.html
        make -j4 html
        popd
```

## Testing Results

### Pass Rate

- **Install tests**: 6/6 passing (100%)
  - Install climpred, macOS
  - Install climpred, Ubuntu
  - Install climpred, Windows
  - Install climpred[complete], macOS
  - Install climpred[complete], Ubuntu
  - Install climpred[complete], Windows

- **Test jobs**: Running (results may vary based on existing test suite)

## Troubleshooting

### Issue: "No module named pytest"

**Cause**: Using `uv run python -m pytest` instead of `uv run pytest`

**Fix**: Use `uv run pytest` directly

### Issue: "Failed to parse uv.lock"

**Cause**: uv.lock format mismatch between local and CI versions

**Fix**: Remove uv.lock from git tracking and let CI generate it

### Issue: "No module named h5py"

**Cause**: h5netcdf doesn't automatically install h5py

**Fix**: Add `h5py` to test dependencies explicitly

### Issue: "nbstripout: command not found"

**Cause**: nbstripout not installed

**Fix**: Add separate `uv run pip install nbstripout` step

### Issue: Tests hang or timeout

**Cause**: May be pre-existing test issues unrelated to uv migration

**Fix**: Investigate specific test failures separately

## Commands Reference

```bash
# Install uv
curl -LsSf https://astral.sh/uv/install.sh | sh

# Install package in editable mode
uv run pip install -e .[complete]

# Run tests
uv run pytest -n 4 --durations=20

# Generate lock file (for CI only)
uv pip compile pyproject.toml -o uv.lock --extra test

# Install with specific Python version
uv run --python 3.9 pip install -e .
```

## Notes

- The uv cache is enabled in CI for faster builds
- Python version is specified in the workflow matrix
- Coverage is uploaded to codecov for maximum test runs
- Read the Docs build may fail due to environment differences
